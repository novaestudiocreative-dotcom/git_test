name: Generate Posts and Deploy to GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - "pages/**"
      - "index.html"
      - "post.html"
      - "css/**"
      - "js/**"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-posts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Generate posts.json
        run: |
          echo "ğŸ“ ê²Œì‹œê¸€ ë©”íƒ€ë°ì´í„° ìƒì„± ì‹œì‘..."

          # posts.json ì´ˆê¸°í™”
          echo "[]" > posts.json

          # pages ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if [ ! -d "pages" ]; then
            echo "âš ï¸ pages ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë¹ˆ posts.jsonì„ ìƒì„±í•©ë‹ˆë‹¤."
            exit 0
          fi

          # Node.js ìŠ¤í¬ë¦½íŠ¸ë¡œ posts.json ìƒì„±
          node -e "
          const fs = require('fs');
          const path = require('path');

          console.log('ğŸ“ pages ë””ë ‰í† ë¦¬ ìŠ¤ìº” ì¤‘...');

          const pagesDir = './pages';
          const posts = [];

          try {
            const files = fs.readdirSync(pagesDir).filter(file => file.endsWith('.md'));
            console.log(\`ğŸ“„ ë°œê²¬ëœ ë§ˆí¬ë‹¤ìš´ íŒŒì¼: \${files.length}ê°œ\`);
            
            files.forEach((file, index) => {
              try {
                const filePath = path.join(pagesDir, file);
                const content = fs.readFileSync(filePath, 'utf8');
                
                // Front Matter íŒŒì‹±
                const frontMatterRegex = /^---\\s*\\n([\\s\\S]*?)\\n---\\s*\\n([\\s\\S]*)$/;
                const match = content.match(frontMatterRegex);
                
                let frontMatter = {};
                let slug = '';
                
                if (match) {
                  const frontMatterText = match[1];
                  const lines = frontMatterText.split('\\n');
                  
                  for (const line of lines) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex === -1) continue;
                    
                    const key = line.substring(0, colonIndex).trim();
                    let value = line.substring(colonIndex + 1).trim();
                    
                    // ë”°ì˜´í‘œ ì œê±°
                    if ((value.startsWith('\"') && value.endsWith('\"')) ||
                        (value.startsWith(\"'\") && value.endsWith(\"'\"))) {
                      value = value.slice(1, -1);
                    }
                    
                    // ë°°ì—´ íŒŒì‹±
                    if (value.startsWith('[') && value.endsWith(']')) {
                      value = value.slice(1, -1)
                        .split(',')
                        .map(item => item.trim().replace(/['\"]/g, ''))
                        .filter(item => item);
                    }
                    
                    frontMatter[key] = value;
                  }
                }
                
                // slug ìƒì„± (íŒŒì¼ëª…ì—ì„œ í™•ì¥ì ì œê±°)
                slug = file.replace(/\\.md$/, '');
                
                // ê¸°ë³¸ê°’ ì„¤ì •
                const post = {
                  slug: slug,
                  file: file,
                  title: frontMatter.title || 'ì œëª© ì—†ìŒ',
                  date: frontMatter.date || new Date().toISOString().split('T')[0],
                  tags: frontMatter.tags || [],
                  category: frontMatter.category || 'ê¸°íƒ€',
                  description: frontMatter.description || '',
                  order: index
                };
                
                posts.push(post);
                console.log(\`âœ… \${file} ì²˜ë¦¬ ì™„ë£Œ: \${post.title}\`);
                
              } catch (error) {
                console.error(\`âŒ \${file} ì²˜ë¦¬ ì‹¤íŒ¨:\`, error.message);
              }
            });
            
            // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
            posts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // posts.json ì €ì¥
            fs.writeFileSync('posts.json', JSON.stringify(posts, null, 2));
            console.log(\`ğŸ“ posts.json ìƒì„± ì™„ë£Œ: \${posts.length}ê°œ ê²Œì‹œê¸€\`);
            
          } catch (error) {
            console.error('âŒ posts.json ìƒì„± ì‹¤íŒ¨:', error.message);
            process.exit(1);
          }
          "

      - name: Commit posts.json
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add posts.json
          git diff --staged --quiet || git commit -m "ğŸ¤– Auto-generate posts.json [skip ci]"
          git push

  deploy:
    needs: generate-posts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
